<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="{{ page.description | default: site.description }}">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap"
    rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="{{ '/assets/css/compiled.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/assets/css/jcanvas/style.css' | relative_url }}">

  <!-- Dark Mode Init (Prevents FOUC) -->
  <script>
    (function () {
      const theme = localStorage.getItem('preferred-theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
</head>

<body id="home" class="canvas-page" style="--scale: 1; --pan-x: 0px; --pan-y: 0px;">

  <div id="container">
    <div id="canvas-container">

      <!-- SVG Edges -->
      <svg id="canvas-edges">
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="8" refX="5" refY="4" orient="auto">
            <polygon points="0 0, 10 4, 0 8" />
          </marker>
        </defs>
        <g id="edge-paths"></g>
      </svg>

      <!-- Canvas Nodes -->
      <div id="canvas-nodes">
        {% assign canvas_data = site.data.canvases.homepage %}
        {% for node in canvas_data.nodes %}
        <node id="{{ node.id }}" class="node node-{{ node.type }}" data-node-type="{{ node.type }}" {% if node.file
          %}data-node-file="{{ node.file }}" {% endif %}
          style="left: {{ node.x }}px; top: {{ node.y }}px; width: {{ node.width }}px; height: {{ node.height }}px;">
          <div class="node-name">{{ node.id }}</div>

          {% if node.type == 'text' %}
          <div class="node-text-content">{{ node.text | markdownify }}</div>
          {% elsif node.type == 'link' %}
          <a href="{{ node.url }}" class="node-link-content">{{ node.text | default: node.url }}</a>
          {% elsif node.type == 'file' %}
          <div class="node-file-content">
            {% assign file_page = site.pages | where: "path", node.file | first %}
            {% if file_page %}
            <!-- {{ file_page.content | markdownify | truncatewords: 50 }} -->
            {{ file_page.content | markdownify }}
            {% else %}
            <p class="text-muted">File: {{ node.file }}</p>
            {% endif %}
          </div>
          {% endif %}
        </node>
        {% endfor %}
      </div>

      <!-- React Islands (will be mounted by garden-widgets.js) -->
      <div data-island="CanvasControls"></div>
      <!-- <div data-island="OutputPanel"></div>
      <div data-island="CanvasExporter"></div>
      <div data-island="CanvasMinimap"></div> -->
    </div>
  </div>

  <!-- Load Vanilla Canvas First -->
  <script src="{{ '/assets/js/canvas.js' | relative_url }}"></script>

  <!-- Initialize Edges Data -->
  <script>
    let edges = {{ canvas_data.edges | jsonify }};
  </script>

  <!-- Load React Bundle (mounts islands automatically) -->
  <script src="{{ '/assets/js/dist/garden-widgets.js' | relative_url }}" defer></script>
</body>

</html>